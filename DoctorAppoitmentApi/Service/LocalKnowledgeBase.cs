using System;
using System.Collections.Generic;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using DoctorAppoitmentApi.Models;
using DoctorAppoitmentApi.Repository;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using System.Text;
using System.Linq;

namespace DoctorAppoitmentApi.Service
{
    public class LocalKnowledgeBase : ILocalKnowledgeBase
    {
        private readonly IDoctorRepository _doctorRepository;
        private readonly ILogger<LocalKnowledgeBase> _logger;
        private readonly AppDbContext _context;
        private readonly Dictionary<string, AppointmentBookingState> _bookingStates;
        
        // Static knowledge patterns
        private readonly Dictionary<string, List<(string pattern, string response)>> _knowledgePatterns;
        
        // Medical conditions patterns
        private readonly Dictionary<string, List<string>> _medicalConditionsPatterns;
        
        // Symptoms patterns
        private readonly Dictionary<string, List<string>> _symptomsPatterns;

        private Dictionary<string, List<string>> _followUpQuestions;
        private Dictionary<string, string> _medicalInformation;

        public LocalKnowledgeBase(
            IDoctorRepository doctorRepository,
            AppDbContext context,
            ILogger<LocalKnowledgeBase> logger)
        {
            _doctorRepository = doctorRepository;
            _context = context;
            _logger = logger;
            _knowledgePatterns = InitializeKnowledgePatterns();
            _medicalConditionsPatterns = InitializeMedicalConditionsPatterns();
            _symptomsPatterns = InitializeSymptomsPatterns();
            _bookingStates = new Dictionary<string, AppointmentBookingState>();
            _followUpQuestions = InitializeFollowUpQuestions();
            _medicalInformation = InitializeMedicalInformation();
        }

        private Dictionary<string, List<(string pattern, string response)>> InitializeKnowledgePatterns()
        {
            return new Dictionary<string, List<(string pattern, string response)>>
            {
                ["authentication"] = new List<(string, string)>
                {
                    (@"(ูุณูุช|ููุฏุช).*ูููุฉ.*(?:ุงููุฑูุฑ|ุงูุณุฑ|ุงูุจุงุณูุฑุฏ)", 
                     "ููููู ุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ ุจุงุชุจุงุน ุงูุฎุทูุงุช ุงูุชุงููุฉ:\n" +
                     "1. ุงุถุบุท ุนูู 'ูุณูุช ูููุฉ ุงููุฑูุฑ' ูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู\n" +
                     "2. ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู ุงููุณุฌู\n" +
                     "3. ุณุชุตูู ุฑุณุงูุฉ ุจูุง ุฑุงุจุท ูุฅุนุงุฏุฉ ุชุนููู ูููุฉ ุงููุฑูุฑ\n" +
                     "4. ุงุชุจุน ุงูุฑุงุจุท ูุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ"),
                    
                    (@"(?:ููู|ุนุงูุฒ).*(?:ุงุณุฌู|ุงูุดุฆ).*ุญุณุงุจ", 
                     "ูุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ:\n" +
                     "1. ุงุถุบุท ุนูู 'ุฅูุดุงุก ุญุณุงุจ' ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ\n" +
                     "2. ุงููุฃ ุงูุจูุงูุงุช ุงููุทููุจุฉ (ุงูุงุณูุ ุงูุจุฑูุฏ ุงูุฅููุชุฑูููุ ุฑูู ุงููุงุชู)\n" +
                     "3. ุงุฎุชุฑ ูููุฉ ูุฑูุฑ ูููุฉ\n" +
                     "4. ุงุถุบุท ุนูู 'ุชุณุฌูู' ูุฅุชูุงู ุงูุนูููุฉ")
                },

                ["appointments"] = new List<(string, string)>
                {
                    (@"(?:ููู|ุนุงูุฒ|ุงุฑูุฏ).*(?:ุงุญุฌุฒ|ุงุนูู).*ููุนุฏ",
                     "ูุญุฌุฒ ููุนุฏ ุฌุฏูุฏ:\n" +
                     "1. ุงุฏุฎู ุนูู ูุณู 'ุงูุฃุทุจุงุก'\n" +
                     "2. ุงุฎุชุฑ ุงูุชุฎุตุต ุงููุทููุจ\n" +
                     "3. ุงุฎุชุฑ ุงูุทุจูุจ ุงูููุงุณุจ\n" +
                     "4. ุญุฏุฏ ุงูููุนุฏ ุงูููุงุณุจ ูู ุงูููุงุนูุฏ ุงููุชุงุญุฉ\n" +
                     "5. ุฃูุฏ ุงูุญุฌุฒ ูุฏูุน ุงูุฑุณูู"),

                    (@"(?:ููู|ุนุงูุฒ).*(?:ุงูุบู|ุงูุบุงุก).*ููุนุฏ",
                     "ูุฅูุบุงุก ููุนุฏ:\n" +
                     "1. ุงุฏุฎู ุนูู 'ููุงุนูุฏู'\n" +
                     "2. ุงุฎุชุฑ ุงูููุนุฏ ุงููุฑุงุฏ ุฅูุบุงุคู\n" +
                     "3. ุงุถุบุท ุนูู 'ุฅูุบุงุก ุงูููุนุฏ'\n" +
                     "4. ุฃูุฏ ุงูุฅูุบุงุก\n" +
                     "* ูููู ุฅูุบุงุก ุงูููุนุฏ ูุจู 24 ุณุงุนุฉ ูู ููุนุฏู"),

                    (@"(?:ุงูู|ููู).*(?:ููุงุนูุฏู|ุญุฌูุฒุงุชู)",
                     "ุณุฃููู ุจุงูุจุญุซ ุนู ููุงุนูุฏู ุงููุณุฌูุฉ...")
                },

                ["medical_advice"] = new List<(string, string)>
                {
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ).*(?:ุงูู|ูุฌุน|ุตุฏุงุน)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุงูุฃูู:\n" +
                     "- ููุฐ ูุชู ุจุฏุฃ ุงูุฃููุ\n" +
                     "- ูู ูู ูุณุชูุฑ ุฃู ูุชูุทุนุ\n" +
                     "- ูู ูุฒุฏุงุฏ ูุน ุงูุญุฑูุฉุ\n" +
                     "ุณุฃููู ุจุชูุฌููู ููุชุฎุตุต ุงูููุงุณุจ"),

                    (@"(?:ุนูุฏู|ููู).*(?:ุญุณุงุณูุฉ|ุญูุฉ|ุทูุญ)",
                     "ุงูุญุณุงุณูุฉ ูุงูุทูุญ ุงูุฌูุฏู ูุฏ ุชููู ููุง ุฃุณุจุงุจ ูุชุนุฏุฏุฉ. ุณุฃูุชุฑุญ ุนููู ุฒูุงุฑุฉ:\n" +
                     "1. ุทุจูุจ ุฌูุฏูุฉ\n" +
                     "2. ุทุจูุจ ุญุณุงุณูุฉ ูููุงุนุฉ\n" +
                     "ูู ุชุฑูุฏ ุฃู ุฃุจุญุซ ูู ุนู ุฃูุฑุจ ููุนุฏ ูุชุงุญุ")
                },

                ["payment"] = new List<(string, string)>
                {
                    (@"(?:ุงูู|ูุง ูู).*(?:ุทุฑู|ูุณุงุฆู).*ุงูุฏูุน",
                     "ููุจู ูุณุงุฆู ุงูุฏูุน ุงูุชุงููุฉ:\n" +
                     "1. ุงูุจุทุงูุงุช ุงูุจูููุฉ (ููุฒุง/ูุงุณุชุฑูุงุฑุฏ)\n" +
                     "2. ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ\n" +
                     "3. ุงูุฏูุน ุงูููุฏู ูู ุงูุนูุงุฏุฉ\n" +
                     "4. ุงูุชุญููู ุงูุจููู"),

                    (@"(?:ูู|ุงูู).*(?:ุณุนุฑ|ุชูููุฉ).*(?:ุงููุดู|ุงูุญุฌุฒ)",
                     "ุชุฎุชูู ุฃุณุนุงุฑ ุงููุดู ุญุณุจ:\n" +
                     "- ุชุฎุตุต ุงูุทุจูุจ\n" +
                     "- ุฏุฑุฌุฉ ุงูุทุจูุจ ุงูุนูููุฉ\n" +
                     "- ููุน ุงูุฒูุงุฑุฉ (ูุดู ุฃูู/ูุชุงุจุนุฉ)\n" +
                     "ููููู ูุนุฑูุฉ ุงูุณุนุฑ ุจุงูุถุจุท ุนูุฏ ุงุฎุชูุงุฑ ุงูุทุจูุจ ูู ุตูุญุฉ ุงูุญุฌุฒ")
                },

                ["medical_symptoms"] = new List<(string, string)>
                {
                    // ุงูุตุฏุงุน
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุตุฏุงุน|ุงูู.*ุฑุงุณ|ูุฌุน.*ุฑุงุณ)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุงูุตุฏุงุน:\n\n" +
                     "1๏ธโฃ ููุฐ ูุชู ุจุฏุฃ ุงูุตุฏุงุนุ\n" +
                     "2๏ธโฃ ูู ุฃู ููุทูุฉ ูู ุงูุฑุฃุณ ูุชุฑูุฒ ุงูุฃููุ\n" +
                     "3๏ธโฃ ูู ูู:\n" +
                     "   โข ูุณุชูุฑ ุฃู ูุชูุทุนุ\n" +
                     "   โข ูุงุจุถ ุฃู ุซุงุจุชุ\n" +
                     "4๏ธโฃ ูู ูุฒุฏุงุฏ ูุน:\n" +
                     "   โข ุงูุญุฑูุฉุ\n" +
                     "   โข ุงูุถูุก ุฃู ุงูุตูุชุ\n" +
                     "   โข ุงูุชูุชุฑ ุฃู ุงูุฅุฌูุงุฏุ\n" +
                     "5๏ธโฃ ูู ูุตุงุญุจู ุฃุนุฑุงุถ ุฃุฎุฑู ูุซู:\n" +
                     "   โข ุบุซูุงู ุฃู ููุกุ\n" +
                     "   โข ุฏูุฎุฉุ\n" +
                     "   โข ุงุถุทุฑุงุจุงุช ูู ุงูุฑุคูุฉุ\n\n" +
                     "๐ฅ ุจูุงุกู ุนูู ุฅุฌุงุจุงุชูุ ุณุฃููู ุจุชูุฌููู ููุชุฎุตุต ุงูููุงุณุจ."),

                    // ุขูุงู ุงููุนุฏุฉ
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุงูู.*ูุนุฏุฉ|ูุฌุน.*ุจุทู|ูุบุต)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุฃูู ุงููุนุฏุฉ:\n\n" +
                     "1๏ธโฃ ููุฐ ูุชู ุจุฏุฃ ุงูุฃููุ\n" +
                     "2๏ธโฃ ูููุน ุงูุฃูู:\n" +
                     "   โข ุฃุนูู ุงูุจุทูุ\n" +
                     "   โข ุญูู ุงูุณุฑุฉุ\n" +
                     "   โข ุฃุณูู ุงูุจุทูุ\n" +
                     "3๏ธโฃ ููุน ุงูุฃูู:\n" +
                     "   โข ุญุงุฏ ุฃู ุฎูููุ\n" +
                     "   โข ูุณุชูุฑ ุฃู ูุชูุทุนุ\n" +
                     "4๏ธโฃ ูู ูุตุงุญุจู:\n" +
                     "   โข ุบุซูุงู ุฃู ููุกุ\n" +
                     "   โข ุฅุณูุงู ุฃู ุฅูุณุงูุ\n" +
                     "   โข ุญุฑูุฉ ูู ุงููุนุฏุฉุ\n" +
                     "   โข ุงูุชูุงุฎุ\n" +
                     "5๏ธโฃ ูู ูุชุฃุซุฑ ุจู:\n" +
                     "   โข ุงูุทุนุงูุ\n" +
                     "   โข ุงูุฌูุนุ\n" +
                     "   โข ุงูุญุฑูุฉุ\n\n" +
                     "๐ฅ ุณุฃุณุงุนุฏู ูู ุชุญุฏูุฏ ูุง ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฒูุงุฑุฉ:\n" +
                     "โข ุทุจูุจ ุจุงุทูุฉ\n" +
                     "โข ุฃุฎุตุงุฆู ุฌูุงุฒ ูุถูู\n" +
                     "โข ุทูุงุฑุฆ"),

                    // ุขูุงู ุงูููุงุตู
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุงูู.*ููุงุตู|ุฎุดููุฉ|ุฑููุงุชูุฒู)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุขูุงู ุงูููุงุตู:\n\n" +
                     "1๏ธโฃ ุงูููุงุตู ุงููุชุฃุซุฑุฉ:\n" +
                     "   โข ุงูุฑูุจุฉุ\n" +
                     "   โข ุงููุชูุ\n" +
                     "   โข ุงูุฑุณุบุ\n" +
                     "   โข ููุงุตู ูุชุนุฏุฏุฉุ\n" +
                     "2๏ธโฃ ุงูุฃุนุฑุงุถ:\n" +
                     "   โข ุชูุฑูุ\n" +
                     "   โข ุงุญูุฑุงุฑุ\n" +
                     "   โข ุชูุจุณ ุตุจุงุญูุ\n" +
                     "3๏ธโฃ ูุชู ูุฒุฏุงุฏ ุงูุฃููุ\n" +
                     "   โข ูุน ุงูุญุฑูุฉุ\n" +
                     "   โข ูู ุงูุฑุงุญุฉุ\n" +
                     "   โข ูู ุงูุตุจุงุญุ\n" +
                     "   โข ูู ุงููุณุงุกุ\n\n" +
                     "๐ฅ ุณุฃุณุงุนุฏู ูู ุชุญุฏูุฏ ูุง ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฒูุงุฑุฉ:\n" +
                     "โข ุทุจูุจ ุนุธุงู\n" +
                     "โข ุทุจูุจ ุฑููุงุชูุฒู\n" +
                     "โข ุทุจูุจ ุทุจูุนู"),

                    // ูุดุงูู ุงูุฌูุฏ
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุญูุฉ|ุทูุญ|ุญุจูุจ|ุงูุฒููุง|ุญุณุงุณูุฉ ุฌูุฏ)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ุงููุดููุฉ ุงูุฌูุฏูุฉ:\n\n" +
                     "1๏ธโฃ ุงูุฃุนุฑุงุถ ุงูุธุงูุฑุฉ:\n" +
                     "   โข ุญูุฉุ\n" +
                     "   โข ุงุญูุฑุงุฑุ\n" +
                     "   โข ุชูุดุฑุ\n" +
                     "   โข ุจุซูุฑุ\n" +
                     "2๏ธโฃ ุงูููุงุทู ุงููุตุงุจุฉ:\n" +
                     "   โข ุงููุฌูุ\n" +
                     "   โข ุงูุฌุณูุ\n" +
                     "   โข ุงูุฃุทุฑุงูุ\n" +
                     "3๏ธโฃ ููุฐ ูุชู ุธูุฑุช ุงูุฃุนุฑุงุถุ\n" +
                     "4๏ธโฃ ูู ููุงู ุนูุงูู ุชุฒูุฏ ุงูุฃุนุฑุงุถ:\n" +
                     "   โข ุงูุชุนุฑุถ ููุดูุณุ\n" +
                     "   โข ุฃุทุนูุฉ ูุนููุฉุ\n" +
                     "   โข ูุณุชุญุถุฑุงุช ุชุฌูููุ\n" +
                     "   โข ุชุนุฑูุ\n\n" +
                     "๐ฅ ุณุฃุณุงุนุฏู ูู ุชุญุฏูุฏ ูุง ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฒูุงุฑุฉ:\n" +
                     "โข ุทุจูุจ ุฌูุฏูุฉ\n" +
                     "โข ุทุจูุจ ุญุณุงุณูุฉ\n" +
                     "โข ุทูุงุฑุฆ ูู ุญุงูุฉ ุงูุชูุฑู ุงูุดุฏูุฏ"),

                    // ูุดุงูู ุงูุชููุณ
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุถูู.*ุชููุณ|ูุญุฉ|ุตุนูุจุฉ.*ุชููุณ)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ูุดุงูู ุงูุชููุณ:\n\n" +
                     "1๏ธโฃ ุงูุฃุนุฑุงุถ:\n" +
                     "   โข ุถูู ูู ุงูุชููุณุ\n" +
                     "   โข ูุญุฉุ\n" +
                     "   โข ุตููุฑ ูู ุงูุตุฏุฑุ\n" +
                     "2๏ธโฃ ูุชู ุชุฒุฏุงุฏ ุงูุฃุนุฑุงุถุ\n" +
                     "   โข ูู ุงูุฑุงุญุฉุ\n" +
                     "   โข ูุน ุงููุฌููุฏุ\n" +
                     "   โข ูู ุงููููุ\n" +
                     "3๏ธโฃ ูู ูุตุงุญุจูุง:\n" +
                     "   โข ุฃูู ูู ุงูุตุฏุฑุ\n" +
                     "   โข ุฎููุงูุ\n" +
                     "   โข ุญููุ\n" +
                     "4๏ธโฃ ูู ูุฏูู:\n" +
                     "   โข ุญุณุงุณูุฉ ุตุฏุฑูุฉุ\n" +
                     "   โข ุชุฏุฎููุ\n\n" +
                     "๐ฅ ุณุฃุณุงุนุฏู ูู ุชุญุฏูุฏ ูุง ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฒูุงุฑุฉ:\n" +
                     "โข ุทุจูุจ ุตุฏุฑูุฉ\n" +
                     "โข ุทุจูุจ ููุจ\n" +
                     "โข ุทูุงุฑุฆ ูู ุงูุญุงูุงุช ุงูุดุฏูุฏุฉ"),

                    // ูุดุงูู ุงูุนูู
                    (@"(?:ุนูุฏู|ุฃุดุนุฑ|ููู).*(?:ุงูู.*ุนูู|ุญูุฉ.*ุนูู|ุงุญูุฑุงุฑ.*ุนูู)",
                     "ูู ูุถูู ุฃุฎุจุฑูู ุจูุฒูุฏ ูู ุงูุชูุงุตูู ุนู ูุดุงูู ุงูุนูู:\n\n" +
                     "1๏ธโฃ ุงูุฃุนุฑุงุถ:\n" +
                     "   โข ุงุญูุฑุงุฑุ\n" +
                     "   โข ุญูุฉุ\n" +
                     "   โข ุฏููุนุ\n" +
                     "   โข ุฃููุ\n" +
                     "2๏ธโฃ ูู ุชุนุงูู ูู:\n" +
                     "   โข ุชุบูุฑ ูู ุงูุฑุคูุฉุ\n" +
                     "   โข ุญุณุงุณูุฉ ููุถูุกุ\n" +
                     "   โข ุฑุคูุฉ ูุงูุงุชุ\n" +
                     "3๏ธโฃ ูู ุงูุฃุนุฑุงุถ:\n" +
                     "   โข ูู ุนูู ูุงุญุฏุฉ ุฃู ุงูุงุซูุชููุ\n" +
                     "   โข ูุณุชูุฑุฉ ุฃู ูุชูุทุนุฉุ\n" +
                     "4๏ธโฃ ูู ุณุจู ูู:\n" +
                     "   โข ุฅุตุงุจุฉ ูู ุงูุนููุ\n" +
                     "   โข ุนูููุฉ ูู ุงูุนููุ\n" +
                     "   โข ุงุฑุชุฏุงุก ุนุฏุณุงุชุ\n\n" +
                     "๐ฅ ุณุฃุณุงุนุฏู ูู ุชุญุฏูุฏ ูุง ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฒูุงุฑุฉ:\n" +
                     "โข ุทุจูุจ ุนููู\n" +
                     "โข ุทูุงุฑุฆ ูู ุญุงูุงุช ุงูุฅุตุงุจุงุช")
                }
            };
        }

        private Dictionary<string, List<string>> InitializeMedicalConditionsPatterns()
        {
            return new Dictionary<string, List<string>>
            {
                ["ููุจ ูุฃูุนูุฉ ุฏูููุฉ"] = new List<string> 
                { 
                    "ุถุบุท ุงูุฏู", "ุฎููุงู", "ุฃูู ูู ุงูุตุฏุฑ", "ุถูู ุชููุณ", "ุชุนุจ ูุน ุงููุฌููุฏ",
                    "ูุจุถ ุณุฑูุน", "ุฏูุฎุฉ", "ุชูุฑู ุงููุฏููู", "ุฒุฑูุฉ", "ุชุนุฑู ุจุงุฑุฏ",
                    "ุฃูู ููุชุดุฑ ููุฐุฑุงุน", "ุตุนูุจุฉ ุงูุชููุณ ุฃุซูุงุก ุงูููู", "ุฑุฌูุงู", "ุฎุฏุฑ ูู ุงูุฐุฑุงุน",
                    "ุชูููู ูู ุงูุฃุทุฑุงู", "ุฏูุงุฑ", "ุบุซูุงู ูุน ุฃูู ุงูุตุฏุฑ", "ุฅุบูุงุก", "ุฏูุงุช ููุจ ุบูุฑ ููุชุธูุฉ"
                },
                ["ุฌูุงุฒ ูุถูู"] = new List<string>
                {
                    "ุญููุถุฉ", "ุญุฑูุงู", "ูุฑุญุฉ", "ุฅูุณุงู", "ุฅุณูุงู", "ุงูุชูุงุฎ", "ุบุซูุงู",
                    "ููุก", "ุฃูู ุจุทู", "ุนุณุฑ ูุถู", "ูุฒูู", "ุจูุงุณูุฑ", "ููุฏุงู ุดููุฉ",
                    "ุตุนูุจุฉ ุงูุจูุน", "ุงุตูุฑุงุฑ ุงูุนูู", "ุจุฑุงุฒ ุฃุณูุฏ", "ุชุฌุดุค", "ูุบุต",
                    "ุญุฑูุฉ ูู ุงููุนุฏุฉ", "ุชููุตุงุช ูู ุงูุจุทู", "ุบุงุฒุงุช", "ุงูุชูุงุฎ ุงูุจุทู"
                },
                ["ุฌูุฏูุฉ"] = new List<string>
                {
                    "ุญูุฉ", "ุทูุญ ุฌูุฏู", "ุงูุฒููุง", "ุญุจูุจ", "ุชูุดุฑ ุงูุฌูุฏ", "ุงุญูุฑุงุฑ",
                    "ุชุบูุฑ ููู ุงูุฌูุฏ", "ุจูุน", "ุตุฏููุฉ", "ุญุณุงุณูุฉ", "ุชุณุงูุท ุดุนุฑ",
                    "ูุทุฑูุงุช", "ุจุซูุฑ", "ุฏูุงูู", "ุชุนุฑู ุฒุงุฆุฏ", "ุญุฑูู ุดูุณ", "ุดุฑู",
                    "ุชูุฑู ุงูุฌูุฏ", "ุญุจูุจ ุงูุดุจุงุจ", "ุซุขููู", "ุชุตุจุบุงุช", "ุชุฌุงุนูุฏ"
                },
                ["ุนุธุงู ูููุงุตู"] = new List<string>
                {
                    "ุฃูู ููุงุตู", "ุชูุฑู ููุงุตู", "ุชูุจุณ ุตุจุงุญู", "ุฎุดููุฉ", "ูุณูุฑ",
                    "ุงูุชูุงุจ ููุงุตู", "ุฑููุงุชูุฒู", "ููุฑุณ", "ุขูุงู ุธูุฑ", "ุขูุงู ุฑูุจุฉ",
                    "ุชูููู", "ุถุนู ุนุถูุงุช", "ุชุดูุฌุงุช", "ุงูุชูุงุก", "ุชููุต ุนุถูู",
                    "ุขูุงู ุงูุฑูุจุฉ", "ูุดุงุดุฉ ุงูุนุธุงู", "ุงูุฒูุงู ุบุถุฑููู", "ุชูุฑู ุงููุงุญู"
                },
                ["ุนููู"] = new List<string>
                {
                    "ุถุนู ูุธุฑ", "ุงุญูุฑุงุฑ ุงูุนูู", "ุญูุฉ ูู ุงูุนูู", "ุฏููุน", "ุฌูุงู",
                    "ุฑุคูุฉ ุถุจุงุจูุฉ", "ุญุณุงุณูุฉ ููุถูุก", "ุตุฏุงุน ูุน ุชุบูุฑ ูู ุงูุฑุคูุฉ",
                    "ุฑุคูุฉ ูุงูุงุช", "ุนูู ูููู", "ุญูู", "ุฃูู ูู ุงูุนูู", "ุงูุชูุงุฎ ุงูุฌูู",
                    "ุนุฏู ูุถูุญ ุงูุฑุคูุฉ", "ุฑุคูุฉ ููุท ุณูุฏุงุก", "ุฑูุด ูุชูุฑุฑ", "ุญุฑูุงู ูู ุงูุนูู"
                },
                ["ุฃูู ูุฃุฐู ูุญูุฌุฑุฉ"] = new List<string>
                {
                    "ุงูุชูุงุจ ููุฒ", "ุตุนูุจุฉ ุจูุน", "ุงูุชูุงุจ ุฃุฐู", "ุทููู", "ููุฏุงู ุณูุน",
                    "ุณููุงู ุฃูู", "ุงูุณุฏุงุฏ ุฃูู", "ุงูุชูุงุจ ุฌููุจ ุฃูููุฉ", "ุจุญุฉ ุตูุช",
                    "ุณุนุงู ูุฒูู", "ุชุถุฎู ูุญููุฉ", "ุตููุฑ ูู ุงูุฃุฐู", "ุฃูู ูู ุงูุฃุฐู",
                    "ูุฒูู ูู ุงูุฃูู", "ููุฏุงู ุญุงุณุฉ ุงูุดู", "ุตุนูุจุฉ ูู ุงูุชููุณ ูู ุงูุฃูู"
                },
                ["ููุณูุฉ ูุนุตุจูุฉ"] = new List<string>
                {
                    "ููู", "ุชูุชุฑ", "ุงูุชุฆุงุจ", "ุฃุฑู", "ุตุนูุจุฉ ุงูููู", "ููุงุจูุณ",
                    "ุชุนุจ ููุณู", "ุนุตุจูุฉ ุฒุงุฆุฏุฉ", "ุตุฏุงุน ุชูุชุฑู", "ูุณูุงุณ ููุฑู",
                    "ููุจุงุช ููุน", "ุฎูู ูุฑุถู", "ุตุนูุจุฉ ุงูุชุฑููุฒ", "ูุณูุงู ูุชูุฑุฑ"
                },
                ["ุบุฏุฏ ุตูุงุก ูุณูุฑู"] = new List<string>
                {
                    "ุนุทุด ุดุฏูุฏ", "ูุซุฑุฉ ุงูุชุจูู", "ุฌูุน ูุณุชูุฑ", "ููุต ูุฒู ููุงุฌุฆ",
                    "ุฒูุงุฏุฉ ูุฒู ุบูุฑ ูุจุฑุฑุฉ", "ุชุนุจ ูุฅุฑูุงู", "ุจุทุก ูู ุงูููู",
                    "ุงุถุทุฑุงุจุงุช ุงูุฏูุฑุฉ ุงูุดูุฑูุฉ", "ุชุณุงูุท ุงูุดุนุฑ", "ุจุฑูุฏุฉ ุฏุงุฆูุฉ"
                },
                ["ุฃูุฑุงุถ ูุณุงุก"] = new List<string>
                {
                    "ุงุถุทุฑุงุจุงุช ุงูุฏูุฑุฉ", "ูุฒูู ููุจูู", "ุฃูู ุฃุณูู ุงูุจุทู", "ุญูุฉ ููุจููุฉ",
                    "ุฅูุฑุงุฒุงุช ุบูุฑ ุทุจูุนูุฉ", "ุชููุณ ุงููุจุงูุถ", "ุขูุงู ุงูุญูุถ", "ุนูู",
                    "ุงููุทุงุน ุงูุทูุซ", "ุชุฃุฎุฑ ุงูุญูู", "ุขูุงู ุงูุซุฏู", "ูุชู ูู ุงูุซุฏู"
                }
            };
        }

        private Dictionary<string, List<string>> InitializeSymptomsPatterns()
        {
            return new Dictionary<string, List<string>>
            {
                ["ุญุฑุงุฑุฉ"] = new List<string> { 
                    "ุณุฎูููุฉ", "ุญูู", "ุงุฑุชูุงุน ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ", "ุณุฎููุฉ", 
                    "ุญุฑุงุฑุฉ ูู ุงูุฌุณู", "ุฌุณูู ุณุฎู", "ุชุนุจ ูุน ุญุฑุงุฑุฉ" 
                },
                ["ุฃูู"] = new List<string> { 
                    "ูุฌุน", "ุตุฏุงุน", "ุขูุงู", "ุฃูุฌุงุน", "ุฃูู ุญุงุฏ", 
                    "ุฃูู ุฎููู", "ูุฌุน ุดุฏูุฏ", "ูุบุฒุงุช", "ุญุฑูุงู" 
                },
                ["ุชุนุจ"] = new List<string> { 
                    "ุฅุฑูุงู", "ุฅุนูุงุก", "ุฎููู", "ุถุนู ุนุงู", "ุชุนุจ ุดุฏูุฏ", 
                    "ุฅุฌูุงุฏ", "ูุชูุฑ", "ูุณู", "ุนุฏู ุงููุฏุฑุฉ ุนูู ุงูุญุฑูุฉ" 
                },
                ["ุฏูุฎุฉ"] = new List<string> { 
                    "ุฏูุงุฑ", "ุฏูุดุฉ", "ูุฎุจุทุฉ", "ุนุฏู ุชูุงุฒู", 
                    "ุงูุฏููุง ุจุชูู", "ุฏุงูุฎ", "ูุด ูุชูุงุฒู" 
                },
                ["ุญุณุงุณูุฉ"] = new List<string> { 
                    "ุญูุฉ", "ุทูุญ", "ูุญุฉ", "ุนุทุณ", "ุฑุดุญ", 
                    "ุฒูุงู", "ุญุณุงุณูุฉ ุตุฏุฑ", "ุถูู ุชููุณ" 
                }
            };
        }

        private Dictionary<string, List<string>> InitializeFollowUpQuestions()
        {
            return new Dictionary<string, List<string>>
            {
                ["ููุจ ูุฃูุนูุฉ ุฏูููุฉ"] = new List<string>
                {
                    "ูู ูุฏูู ุชุงุฑูุฎ ุนุงุฆูู ูุฃูุฑุงุถ ุงูููุจุ",
                    "ูู ุชุนุงูู ูู ุงุฑุชูุงุน ุถุบุท ุงูุฏูุ",
                    "ูู ุชุฏุฎูุ",
                    "ูู ุชูุงุฑุณ ุงูุฑูุงุถุฉ ุจุงูุชุธุงูุ",
                    "ูู ุชุชุจุน ูุธุงูุงู ุบุฐุงุฆูุงู ุตุญูุงูุ"
                },
                ["ุฌูุงุฒ ูุถูู"] = new List<string>
                {
                    "ูุชู ุจุฏุฃุช ุงูุฃุนุฑุงุถุ",
                    "ูู ุชูุงููุช ุทุนุงูุงู ุบูุฑ ูุนุชุงุฏ ูุคุฎุฑุงูุ",
                    "ูู ูุฏูู ุญุณุงุณูุฉ ูู ุฃุทุนูุฉ ูุนููุฉุ",
                    "ูู ุชุนุงูู ูู ุงูุฅูุณุงู ุฃู ุงูุฅุณูุงูุ",
                    "ูู ูุงุญุธุช ุฃู ุชุบููุฑ ูู ุดููุชูุ"
                }
                // Add more specialties and their follow-up questions
            };
        }

        private Dictionary<string, string> InitializeMedicalInformation()
        {
            return new Dictionary<string, string>
            {
                ["ุถุบุท ุงูุฏู"] = @"ุถุบุท ุงูุฏู ุงูุทุจูุนู ูุชุฑุงูุญ ุจูู 120/80. 
                    โข ุงุฑุชูุงุน ุถุบุท ุงูุฏู: ุฃุนูู ูู 140/90
                    โข ุงูุฎูุงุถ ุถุบุท ุงูุฏู: ุฃูู ูู 90/60
                    
                    ูุตุงุฆุญ ููุชุญูู ูู ุถุบุท ุงูุฏู:
                    โข ุชูููู ุงูููุญ ูู ุงูุทุนุงู
                    โข ููุงุฑุณุฉ ุงูุฑูุงุถุฉ ุจุงูุชุธุงู
                    โข ุงูุฅููุงุน ุนู ุงูุชุฏุฎูู
                    โข ุชุฌูุจ ุงูุชูุชุฑ
                    โข ุชูุงูู ุงูุฃุฏููุฉ ุจุงูุชุธุงู ุฅุฐุง ูุตููุง ุงูุทุจูุจ",

                ["ุงูุณูุฑู"] = @"ูุณุชููุงุช ุงูุณูุฑ ุงูุทุจูุนูุฉ ูู ุงูุฏู:
                    โข ุตุงุฆู: 70-100 ููุบ/ุฏู
                    โข ุจุนุฏ ุงูุฃูู ุจุณุงุนุชูู: ุฃูู ูู 140 ููุบ/ุฏู
                    
                    ุนูุงูุงุช ุงุฑุชูุงุน ุงูุณูุฑ:
                    โข ุงูุนุทุด ุงูุดุฏูุฏ
                    โข ูุซุฑุฉ ุงูุชุจูู
                    โข ุงูุฌูุน ุงููุณุชูุฑ
                    โข ุงูุชุนุจ ูุงูุฅุฑูุงู
                    
                    ูุตุงุฆุญ ููุชุญูู ูู ุงูุณูุฑู:
                    โข ุชูุงูู ุงูุฃุฏููุฉ ุจุงูุชุธุงู
                    โข ูุฑุงูุจุฉ ูุณุชูู ุงูุณูุฑ ููููุงู
                    โข ุงุชุจุงุน ูุธุงู ุบุฐุงุฆู ุตุญู
                    โข ููุงุฑุณุฉ ุงูุฑูุงุถุฉ ุจุงูุชุธุงู"
                // Add more medical information
            };
        }

        public async Task<(bool matched, string response)> GetResponseAsync(string query, string? userId = null)
        {
            try
            {
                // 1. Check if this is part of an ongoing booking process
                if (!string.IsNullOrEmpty(userId) && _bookingStates.ContainsKey(userId))
                {
                    var (success, message) = await ProcessAppointmentBooking(userId, query, "ongoing");
                    return (true, message);
                }

                // 2. Check for doctor-related queries first
                if (await IsDoctorQuery(query))
                {
                    var (specialty, confidence) = await DetectSpecialtyAsync(query);
                    _logger?.LogInformation($"Detected specialty: {specialty} with confidence: {confidence}");

                    if (!string.IsNullOrEmpty(specialty))
                    {
                        var doctors = await _doctorRepository.FindAllDoctorsBySpecialtyNameAsync(specialty);
                        if (doctors.Any())
                        {
                            // ุชุญููู ุงุณู ุงูุชุฎุตุต ููุนุฑุจูุฉ
                            var arabicSpecialty = specialty switch
                            {
                                "Dermatology" => "ุงูุฌูุฏูุฉ",
                                "Orthopedics" => "ุงูุนุธุงู",
                                "Cardiology" => "ุงูููุจ",
                                "Pediatrics" => "ุงูุฃุทูุงู",
                                "Gynecology" => "ุงููุณุงุก ูุงูุชูููุฏ",
                                "ENT" => "ุงูุฃูู ูุงูุฃุฐู ูุงูุญูุฌุฑุฉ",
                                "Internal Medicine" => "ุงูุจุงุทูุฉ",
                                _ => specialty
                            };

                            var response = new StringBuilder();
                            response.AppendLine($"๐ฅ ูุชุงุฆุฌ ุงูุจุญุซ ุนู ุฃุทุจุงุก {arabicSpecialty}");
                            response.AppendLine("โโโโโโโโโโโโโโโโโโโโโโ");
                            response.AppendLine($"ุนุฏุฏ ุงูุฃุทุจุงุก ุงููุชููุฑูู: {doctors.Count()}");
                            response.AppendLine();

                            foreach (var doctor in doctors.Take(3))
                            {
                                response.AppendLine($"๐จโโ๏ธ ุฏ. {doctor.FirstName} {doctor.LastName}");
                                response.AppendLine($"   โข ุงูุชุฎุตุต: {arabicSpecialty}");
                                response.AppendLine($"   โข ุณุนุฑ ุงููุดู: {doctor.CurrentFee} ุฌููู");
                                response.AppendLine($"   โข ูุนุฑู ุงูุทุจูุจ: {doctor.Id}");
                                response.AppendLine("โโโโโโโโโโโโโโ");
                            }

                            response.AppendLine();
                            response.AppendLine("๐ ูุญุฌุฒ ููุนุฏ:");
                            response.AppendLine("ุงูุชุจ 'ุนุงูุฒ ุงุญุฌุฒ ูุน ุฏูุชูุฑ' ูุชุจูุนุงู ุจุฑูู ูุนุฑู ุงูุทุจูุจ");
                            response.AppendLine("ูุซุงู: ุนุงูุฒ ุงุญุฌุฒ ูุน ุฏูุชูุฑ 3");

                            // ุฅุถุงูุฉ ุงูุฃุณุฆูุฉ ุงูููุชุฑุญุฉ
                            var suggestions = await GetSuggestedQuestionsAsync(query);
                            if (suggestions.Any())
                            {
                                response.AppendLine();
                                response.AppendLine("โ ุฃุณุฆูุฉ ุดุงุฆุนุฉ:");
                                foreach (var suggestion in suggestions.Take(3))
                                {
                                    response.AppendLine($"โข {suggestion}");
                                }
                            }

                            return (true, response.ToString());
                        }
                        else
                        {
                            return (true, $"โ๏ธ ุนุฐุฑุงูุ ูุง ููุฌุฏ ุญุงููุงู ุฃุทุจุงุก ูุชุฎุตุตูู ูู {specialty}.\n\n" +
                                        "ูู ุชุฑูุฏ:\n" +
                                        "โข ุงูุจุญุซ ูู ุชุฎุตุต ุขุฎุฑุ\n" +
                                        "โข ูุนุฑูุฉ ุงูุชุฎุตุตุงุช ุงููุชููุฑุฉุ\n" +
                                        "โข ุงูุชุญุฏุซ ูุน ุฎุฏูุฉ ุงูุนููุงุกุ");
                        }
                    }
                }

                // 3. Check if user specific response is needed
                if (!string.IsNullOrEmpty(userId))
                {
                    var (userMatched, userResponse) = await GetPatientSpecificResponseAsync(query, userId);
                    if (userMatched) return (true, userResponse);
                }

                // 4. Check static patterns
                foreach (var category in _knowledgePatterns)
                {
                    foreach (var (pattern, response) in category.Value)
                    {
                        if (Regex.IsMatch(query, pattern, RegexOptions.IgnoreCase))
                        {
                            return (true, response);
                        }
                    }
                }

                // 5. Check for medical advice
                var (medicalMatched, medicalResponse) = await GetMedicalAdviceAsync(query);
                if (medicalMatched) return (true, medicalResponse);

                // 6. No match found - provide helpful suggestions
                return (false, "ุนุฐุฑุงูุ ูู ุฃููู ุทูุจู ุจุดูู ูุงูู. ูู ุชุฑูุฏ:\n" +
                             "1. ุงูุจุญุซ ุนู ุทุจูุจ ูู ุชุฎุตุต ูุนููุ\n" +
                             "2. ุญุฌุฒ ููุนุฏ ูุน ุทุจูุจ ูุญุฏุฏุ\n" +
                             "3. ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุงูุชุฎุตุตุงุช ุงููุชููุฑุฉุ\n" +
                             "4. ุงูุงุณุชูุณุงุฑ ุนู ููุงุนูุฏู ุงูุญุงููุฉุ");
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in LocalKnowledgeBase.GetResponseAsync");
                return (false, "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
        }

        public async Task<(bool matched, string response)> GetPatientSpecificResponseAsync(string query, string userId)
        {
            try
            {
                // Get patient information
                var patient = await _context.Patients
                    .Include(p => p.ApplicationUser)
                    .Include(p => p.Appointments)
                        .ThenInclude(a => a.Doctor)
                            .ThenInclude(d => d.Specialization)
                    .FirstOrDefaultAsync(p => p.ApplicationUserId == userId);

                if (patient == null) return (false, string.Empty);

                // Check for appointment related queries
                if (query.Contains("ููุงุนูุฏู") || query.Contains("ุญุฌูุฒุงุชู"))
                {
                    var appointments = await GetPatientAppointmentsAsync(userId);
                    if (!appointments.Any())
                        return (true, "ูุง ููุฌุฏ ูุฏูู ููุงุนูุฏ ุญุงููุฉ.");

                    var response = "ููุงุนูุฏู ุงููุงุฏูุฉ:\n";
                    foreach (var apt in appointments)
                    {
                        response += $"- ููุนุฏ ูุน ุฏ. {apt.Doctor.FirstName} {apt.Doctor.LastName} " +
                                  $"({apt.Doctor.Specialization.Name}) " +
                                  $"ูู {apt.AppointmentDate:dd/MM/yyyy} " +
                                  $"ุงูุณุงุนุฉ {apt.StartTime:hh:mm tt}\n";
                    }
                    return (true, response);
                }

                // Check for medical history queries
                if (query.Contains("ุชุงุฑูุฎู ุงูุทุจู") || query.Contains("ุณุฌูู ุงูุทุจู"))
                {
                    if (string.IsNullOrEmpty(patient.MedicalHistory))
                        return (true, "ูู ูุชู ุชุณุฌูู ุฃู ุชุงุฑูุฎ ุทุจู ุณุงุจู. ูู ุชุฑูุฏ ุฅุถุงูุฉ ูุนูููุงุช ุทุจูุฉุ");

                    return (true, $"ุชุงุฑูุฎู ุงูุทุจู:\n{patient.MedicalHistory}");
                }

                return (false, string.Empty);
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetPatientSpecificResponseAsync");
                return (false, string.Empty);
            }
        }

        public async Task<(bool matched, string response)> GetMedicalAdviceAsync(string symptoms)
        {
            try
            {
                var matchedConditions = new Dictionary<string, List<string>>();
                var urgencyLevel = AssessUrgencyLevel(symptoms);
                var response = new StringBuilder();

                foreach (var condition in _medicalConditionsPatterns)
                {
                    var matchedSymptoms = condition.Value
                        .Where(symptom => symptoms.Contains(symptom, StringComparison.OrdinalIgnoreCase))
                        .ToList();

                    if (matchedSymptoms.Any())
                    {
                        matchedConditions.Add(condition.Key, matchedSymptoms);
                    }
                }

                if (matchedConditions.Any())
                {
                    response.AppendLine("๐ฅ ุชุญููู ุงูุฃุนุฑุงุถ:");
                    response.AppendLine("โโโโโโโโโโโโโโ");

                    foreach (var condition in matchedConditions)
                    {
                        response.AppendLine($"โพ ุชุฎุตุต {condition.Key}:");
                        response.AppendLine($"  ุงูุฃุนุฑุงุถ ุงููุทุงุจูุฉ: {string.Join("ุ ", condition.Value)}");
                        
                        // Get doctors for this specialty
                        var doctors = await _doctorRepository.FindAllDoctorsBySpecialtyNameAsync(condition.Key);
                        if (doctors.Any())
                        {
                            response.AppendLine($"\n  ๐จโโ๏ธ ุงูุฃุทุจุงุก ุงููุชุฎุตุตูู ุงููุชุงุญูู:");
                            foreach (var doctor in doctors.Take(3))
                            {
                                response.AppendLine($"  โข ุฏ. {doctor.FirstName} {doctor.LastName}");
                            }
                        }
                        response.AppendLine("โโโโโโโโโโโโโโ");
                    }

                    // Add urgency advice
                    response.AppendLine($"\nโ๏ธ ูุณุชูู ุงูุฃููููุฉ: {GetUrgencyLevelText(urgencyLevel)}");
                    
                    if (urgencyLevel == UrgencyLevel.Emergency)
                    {
                        response.AppendLine("\n๐จ ุชูุจูู: ูููุตุญ ุจุงูุชูุฌู ููุฑุงู ุฅูู ุฃูุฑุจ ุทูุงุฑุฆ.");
                    }
                    else if (urgencyLevel == UrgencyLevel.Urgent)
                    {
                        response.AppendLine("\nโก ุชูุจูู: ูููุตุญ ุจุฒูุงุฑุฉ ุงูุทุจูุจ ูู ุฃูุฑุจ ููุช ูููู (ุฎูุงู 24 ุณุงุนุฉ).");
                    }

                    // Add general advice
                    response.AppendLine("\n๐ก ูุตุงุฆุญ ุนุงูุฉ:");
                    response.AppendLine("โข ุงุญุชูุธ ุจุณุฌู ููุตู ูุฃุนุฑุงุถู ูุชูููุชูุง");
                    response.AppendLine("โข ูู ุจููุงุณ ุงูุนูุงูุงุช ุงูุญูููุฉ ุฅู ุฃููู (ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉุ ุถุบุท ุงูุฏู)");
                    response.AppendLine("โข ุชุฌูุจ ุชูุงูู ุฃู ุฃุฏููุฉ ุฏูู ุงุณุชุดุงุฑุฉ ุทุจูุฉ");

                    // Add booking instructions
                    response.AppendLine("\n๐ ูุญุฌุฒ ููุนุฏ:");
                    response.AppendLine("1. ุงุฎุชุฑ ุงูุชุฎุตุต ุงูููุงุณุจ ูู ุงููุงุฆูุฉ ุฃุนูุงู");
                    response.AppendLine("2. ุงูุชุจ 'ุนุงูุฒ ุงุญุฌุฒ ูุน ุฏูุชูุฑ' ูุชุจูุนุงู ุจุฑูู ูุนุฑู ุงูุทุจูุจ");
                    response.AppendLine("ูุซุงู: ุนุงูุฒ ุงุญุฌุฒ ูุน ุฏูุชูุฑ 3");

                    return (true, response.ToString());
                }

                return (false, string.Empty);
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetMedicalAdviceAsync");
                return (false, string.Empty);
            }
        }

        private UrgencyLevel AssessUrgencyLevel(string symptoms)
        {
            var emergencySymptoms = new[]
            {
                "ุฃูู ุดุฏูุฏ ูู ุงูุตุฏุฑ", "ุตุนูุจุฉ ูู ุงูุชููุณ", "ูุฒูู ุดุฏูุฏ",
                "ููุฏุงู ุงููุนู", "ุดูู", "ุชุดูุฌุงุช", "ุฅุบูุงุก",
                "ุฅุตุงุจุฉ ุดุฏูุฏุฉ ูู ุงูุฑุฃุณ", "ุฃูู ุจุทู ุญุงุฏ"
            };

            var urgentSymptoms = new[]
            {
                "ุญูู ุดุฏูุฏุฉ", "ุฃูู ุดุฏูุฏ", "ุตุฏุงุน ุดุฏูุฏ",
                "ููุก ูุณุชูุฑ", "ุฅุณูุงู ุดุฏูุฏ", "ุฌูุงู",
                "ุชูุฑู ููุงุฌุฆ", "ุถูู ุชููุณ ูุชูุณุท"
            };

            if (emergencySymptoms.Any(s => symptoms.Contains(s, StringComparison.OrdinalIgnoreCase)))
            {
                return UrgencyLevel.Emergency;
            }
            
            if (urgentSymptoms.Any(s => symptoms.Contains(s, StringComparison.OrdinalIgnoreCase)))
            {
                return UrgencyLevel.Urgent;
            }

            return UrgencyLevel.Normal;
        }

        private string GetUrgencyLevelText(UrgencyLevel level)
        {
            return level switch
            {
                UrgencyLevel.Emergency => "๐ด ุญุงูุฉ ุทุงุฑุฆุฉ - ุชุชุทูุจ ุนูุงูุฉ ููุฑูุฉ",
                UrgencyLevel.Urgent => "๐ก ุนุงุฌู - ุชุชุทูุจ ุนูุงูุฉ ุฎูุงู 24 ุณุงุนุฉ",
                _ => "๐ข ุนุงุฏู - ูููู ุญุฌุฒ ููุนุฏ ุนูุงุฏุฉ"
            };
        }

        private enum UrgencyLevel
        {
            Normal,
            Urgent,
            Emergency
        }

        public async Task<List<string>> GetSuggestedQuestionsAsync(string currentQuery)
        {
            var suggestions = new List<string>();
            
            // Add context-aware suggestions based on current query
            if (currentQuery.Contains("ุฏูุชูุฑ") || currentQuery.Contains("ุทุจูุจ"))
            {
                suggestions.AddRange(new[]
                {
                    "ููู ุฃุญุฌุฒ ููุนุฏ ูุน ุงูุฏูุชูุฑุ",
                    "ูุง ูู ููุงุนูุฏ ุงูุนููุ",
                    "ูู ุณุนุฑ ุงููุดูุ",
                    "ูู ููุจู ุงูุชุฃููู ุงูุตุญูุ"
                });
            }
            
            if (currentQuery.Contains("ุญุฌุฒ") || currentQuery.Contains("ููุนุฏ"))
            {
                suggestions.AddRange(new[]
                {
                    "ูุง ูู ุทุฑู ุงูุฏูุน ุงููุชุงุญุฉุ",
                    "ููู ูููููู ุฅูุบุงุก ุงูููุนุฏุ",
                    "ูู ูููููู ุชุบููุฑ ููุนุฏ ุงูุญุฌุฒุ",
                    "ูู ูุฏุฉ ุงููุดูุ"
                });
            }

            if (currentQuery.Contains("ุฃูู") || currentQuery.Contains("ูุฌุน"))
            {
                suggestions.AddRange(new[]
                {
                    "ูุง ูู ุฃูุฑุจ ููุนุฏ ูุชุงุญุ",
                    "ูู ูููููู ุงุณุชุดุงุฑุฉ ุทุจูุจ ุนู ุจุนุฏุ",
                    "ูุง ูู ุงูุฃูุฑุงู ุงููุทููุจุฉ ูููุดูุ"
                });
            }

            return suggestions;
        }

        public async Task<(string specialty, float confidence)> DetectSpecialtyAsync(string query)
        {
            var specialtyMappings = new Dictionary<string, (string DbName, List<string> Keywords)>
            {
                ["Dermatology"] = ("Dermatology", new List<string> { 
                    // Arabic
                    "ุฌูุฏ", "ุจุดุฑุฉ", "ุฌูุฏูุฉ", "ุฌูุฏูู", "ุญุณุงุณูุฉ ุฌูุฏ", "ุญุจูุจ", "ุทูุญ", "ุงูุฒููุง",
                    // English
                    "skin", "dermatology", "dermatologist", "rash", "acne", "eczema", "allergy"
                }),
                ["Orthopedics"] = ("Orthopedics", new List<string> { 
                    // Arabic
                    "ุนุธุงู", "ุนุธู", "ููุงุตู", "ูุณูุฑ", "ุฑุถูุถ", "ุธูุฑ", "ุฑูุจุฉ", "ุฎุดููุฉ",
                    // English
                    "orthopedic", "bone", "joint", "fracture", "back", "knee", "arthritis"
                }),
                ["Cardiology"] = ("Cardiology", new List<string> { 
                    // Arabic
                    "ููุจ", "ููุจูุฉ", "ุตุฏุฑ", "ุถุบุท", "ุดุฑุงููู", "ุฎููุงู", "ูุจุถ", "ุฐุจุญุฉ",
                    // English
                    "heart", "cardiac", "cardiology", "cardiologist", "chest", "blood pressure", "cardiovascular"
                }),
                ["Pediatrics"] = ("Pediatrics", new List<string> { 
                    // Arabic
                    "ุงุทูุงู", "ุทูู", "ุฑุถูุน", "ุญุฏูุซ ููุงุฏุฉ", "ุชุทุนูู", "ููู", "ุญุถุงูุฉ",
                    // English
                    "pediatric", "pediatrician", "child", "children", "baby", "newborn", "vaccination"
                }),
                ["Gynecology"] = ("Gynecology", new List<string> { 
                    // Arabic
                    "ูุณุงุก", "ููุงุฏุฉ", "ุญูู", "ูุณุงุฆูุฉ", "ุชูููุฏ", "ุฑุญู", "ูุจูุถ",
                    // English
                    "gynecology", "obstetrics", "pregnancy", "obgyn", "women", "uterus", "ovary"
                }),
                ["ENT"] = ("ENT", new List<string> { 
                    // Arabic
                    "ุงูู", "ุงุฐู", "ุญูุฌุฑุฉ", "ุญูู", "ุณูุน", "ููุฒ", "ุฌููุจ ุงูููุฉ",
                    // English
                    "ent", "ear", "nose", "throat", "hearing", "tonsils", "sinus"
                }),
                ["Internal Medicine"] = ("Internal Medicine", new List<string> { 
                    // Arabic
                    "ุจุงุทูุฉ", "ุจุงุทููุฉ", "ูุนุฏุฉ", "ุงูุนุงุก", "ูุถู", "ูุจุฏ", "ูุฑุงุฑุฉ", "ููููู",
                    // English
                    "internal", "medicine", "stomach", "digestive", "liver", "gallbladder", "colon"
                })
            };

            var maxConfidence = 0f;
            var detectedSpecialty = "";
            var normalizedQuery = query.ToLower();

            foreach (var mapping in specialtyMappings)
            {
                var matchCount = mapping.Value.Keywords
                    .Count(keyword => normalizedQuery.Contains(keyword.ToLower()));
                
                var confidence = matchCount > 0 ? (float)matchCount / mapping.Value.Keywords.Count : 0;
                
                if (confidence > maxConfidence)
                {
                    maxConfidence = confidence;
                    detectedSpecialty = mapping.Value.DbName;
                }
            }

            _logger?.LogInformation($"Query: {query}, Detected specialty: {detectedSpecialty}, Confidence: {maxConfidence}");

            return (detectedSpecialty, maxConfidence);
        }

        private async Task<bool> IsDoctorQuery(string query)
        {
            var doctorPatterns = new[]
            {
                // Arabic Patterns
                @"(?:ุนุงูุฒ|ูุญุชุงุฌ|ุงุฑูุฏ).*(?:ุฏูุชูุฑ|ุทุจูุจ)",
                @"(?:ููู|ููู).*(?:ุฏูุชูุฑ|ุทุจูุจ)",
                @"(?:ุงุญุณู|ุงูุถู).*(?:ุฏูุชูุฑ|ุทุจูุจ)",
                @"(?:ุงูุฑุจ|ุงูู).*(?:ุฏูุชูุฑ|ุทุจูุจ)",
                
                // English Patterns
                @"(?:need|want|looking).*(?:doctor|physician)",
                @"(?:find|search).*(?:doctor|physician)",
                @"(?:best|good).*(?:doctor|physician)",
                @"(?:nearest|closest).*(?:doctor|physician)"
            };

            return doctorPatterns.Any(pattern => Regex.IsMatch(query, pattern, RegexOptions.IgnoreCase));
        }

        public async Task<List<Appointment>> GetPatientAppointmentsAsync(string userId)
        {
            try
            {
                return await _context.Appointments
                    .Include(a => a.Doctor)
                        .ThenInclude(d => d.Specialization)
                    .Include(a => a.Patient)
                    .Where(a => a.Patient.ApplicationUserId == userId && 
                           a.AppointmentDate >= DateTime.Today)
                    .OrderBy(a => a.AppointmentDate)
                    .ThenBy(a => a.StartTime)
                    .ToListAsync();
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error getting patient appointments");
                return new List<Appointment>();
            }
        }

        public async Task<(bool success, string message)> InitiateAppointmentBooking(string userId, int doctorId)
        {
            try
            {
                var doctor = await _context.Doctors
                    .Include(d => d.Specialization)
                    .FirstOrDefaultAsync(d => d.Id == doctorId);

                if (doctor == null)
                    return (false, "ุนุฐุฑุงูุ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุทุจูุจ ุงููุทููุจ.");

                var patient = await _context.Patients
                    .FirstOrDefaultAsync(p => p.ApplicationUserId == userId);

                if (patient == null)
                    return (false, "ุนุฐุฑุงูุ ูุฌุจ ุฅููุงู ูููู ุงูุดุฎุตู ุฃููุงู.");

                // Initialize booking state
                var bookingState = new AppointmentBookingState
                {
                    DoctorId = doctorId,
                    PatientId = patient.Id,
                    CurrentStep = BookingStep.SelectDate,
                    Doctor = doctor
                };

                _bookingStates[userId] = bookingState;

                return (true, $"ุญุณูุงูุ ุณูุจุฏุฃ ุญุฌุฒ ููุนุฏ ูุน ุฏ. {doctor.FirstName} {doctor.LastName} ({doctor.Specialization.Name})\n" +
                             "ูู ูุถูู ุงุฎุชุฑ ุงูุชุงุฑูุฎ ุงูููุงุณุจ (ูุซุงู: 25/12/2024):");
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error initiating appointment booking");
                return (false, "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุจุฏุก ุนูููุฉ ุงูุญุฌุฒ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
        }

        public async Task<(bool success, string message)> ProcessAppointmentBooking(string userId, string userInput, string currentState)
        {
            if (!_bookingStates.ContainsKey(userId))
                return (false, "ุนุฐุฑุงูุ ูุฌุจ ุจุฏุก ุนูููุฉ ุงูุญุฌุฒ ุฃููุงู.");

            var bookingState = _bookingStates[userId];

            try
            {
                switch (bookingState.CurrentStep)
                {
                    case BookingStep.SelectDate:
                        if (DateTime.TryParse(userInput, out DateTime selectedDate))
                        {
                            if (selectedDate.Date < DateTime.Today)
                                return (false, "ุนุฐุฑุงูุ ูุง ูููู ุงุฎุชูุงุฑ ุชุงุฑูุฎ ูู ุงููุงุถู. ุงุฎุชุฑ ุชุงุฑูุฎุงู ูุณุชูุจููุงู:");

                            bookingState.AppointmentDate = selectedDate;
                            bookingState.CurrentStep = BookingStep.SelectTime;

                            // Get available time slots
                            var availableSlots = await GetAvailableTimeSlots(bookingState.DoctorId, selectedDate);
                            if (!availableSlots.Any())
                                return (false, "ุนุฐุฑุงูุ ูุง ุชูุฌุฏ ููุงุนูุฏ ูุชุงุญุฉ ูู ูุฐุง ุงูููู. ุงุฎุชุฑ ุชุงุฑูุฎุงู ุขุฎุฑ:");

                            return (true, "ุงุฎุชุฑ ููุช ุงูููุนุฏ ุงูููุงุณุจ ูู ุงูููุงุนูุฏ ุงููุชุงุญุฉ:\n" +
                                        string.Join("\n", availableSlots.Select(s => $"- {s:HH:mm}")));
                        }
                        return (false, "ุตูุบุฉ ุงูุชุงุฑูุฎ ุบูุฑ ุตุญูุญุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูุชุงุฑูุฎ ุจุงูุตูุบุฉ ุงูุตุญูุญุฉ (ูุซุงู: 25/12/2024):");

                    case BookingStep.SelectTime:
                        if (TimeSpan.TryParse(userInput, out TimeSpan selectedTime))
                        {
                            // Validate time slot availability
                            var availableSlots = await GetAvailableTimeSlots(bookingState.DoctorId, bookingState.AppointmentDate);
                            if (!availableSlots.Contains(selectedTime))
                                return (false, "ุนุฐุฑุงูุ ูุฐุง ุงูููุนุฏ ุบูุฑ ูุชุงุญ. ุงุฎุชุฑ ููุนุฏุงู ุขุฎุฑ ูู ุงูููุงุนูุฏ ุงููุชุงุญุฉ:");

                            bookingState.AppointmentTime = selectedTime;
                            bookingState.CurrentStep = BookingStep.Confirm;

                            var doctor = bookingState.Doctor;
                            return (true, $"ูุฑุงุฌุนุฉ ุชูุงุตูู ุงูุญุฌุฒ:\n" +
                                        $"ุงูุทุจูุจ: ุฏ. {doctor.FirstName} {doctor.LastName}\n" +
                                        $"ุงูุชุฎุตุต: {doctor.Specialization.Name}\n" +
                                        $"ุงูุชุงุฑูุฎ: {bookingState.AppointmentDate:dd/MM/yyyy}\n" +
                                        $"ุงูููุช: {bookingState.AppointmentTime:hh\\:mm}\n" +
                                        $"ุณุนุฑ ุงููุดู: {doctor.CurrentFee}\n\n" +
                                        "ููุชุฃููุฏ ุงูุชุจ 'ุชุฃููุฏ' ุฃู 'ุฅูุบุงุก' ููุฅูุบุงุก:");
                        }
                        return (false, "ุตูุบุฉ ุงูููุช ุบูุฑ ุตุญูุญุฉ. ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูููุช ุจุงูุตูุบุฉ ุงูุตุญูุญุฉ (ูุซุงู: 14:30):");

                    case BookingStep.Confirm:
                        if (userInput.Contains("ุชุฃููุฏ"))
                        {
                            // Create appointment
                            var appointment = new Appointment
                            {
                                DoctorID = bookingState.DoctorId,
                                PatientID = bookingState.PatientId,
                                AppointmentDate = bookingState.AppointmentDate,
                                StartTime = bookingState.AppointmentTime,
                                EndTime = bookingState.AppointmentTime.Add(TimeSpan.FromMinutes(30)),
                                Status = "Pending",
                                AppointmentFee = bookingState.Doctor.CurrentFee
                            };

                            _context.Appointments.Add(appointment);
                            await _context.SaveChangesAsync();

                            // Clean up booking state
                            _bookingStates.Remove(userId);

                            return (true, "ุชู ุชุฃููุฏ ุงูุญุฌุฒ ุจูุฌุงุญ! ุณุชุตูู ุฑุณุงูุฉ ุชุฃููุฏ ุนูู ุจุฑูุฏู ุงูุฅููุชุฑููู ููุงุชูู ุงููุญููู.");
                        }
                        else if (userInput.Contains("ุฅูุบุงุก"))
                        {
                            _bookingStates.Remove(userId);
                            return (true, "ุชู ุฅูุบุงุก ุนูููุฉ ุงูุญุฌุฒ. ูู ุชุฑูุฏ ุงูุจุญุซ ุนู ููุนุฏ ุขุฎุฑุ");
                        }
                        return (false, "ูู ูุถูู ุงูุชุจ 'ุชุฃููุฏ' ูููุชุงุจุนุฉ ุฃู 'ุฅูุบุงุก' ูุฅูุบุงุก ุงูุญุฌุฒ:");

                    default:
                        return (false, "ุญุฏุซ ุฎุทุฃ ูู ุนูููุฉ ุงูุญุฌุฒ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
                }
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error processing appointment booking");
                return (false, "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุญุฌุฒ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
        }

        private async Task<List<TimeSpan>> GetAvailableTimeSlots(int doctorId, DateTime date)
        {
            try
            {
                // Get doctor's working hours and existing appointments
                var doctor = await _context.Doctors
                    .Include(d => d.Clinic)
                    .FirstOrDefaultAsync(d => d.Id == doctorId);

                if (doctor?.Clinic == null)
                    return new List<TimeSpan>();

                var existingAppointments = await _context.Appointments
                    .Where(a => a.DoctorID == doctorId && 
                           a.AppointmentDate.Date == date.Date &&
                           a.Status != "Cancelled")
                    .Select(a => new { a.StartTime, a.EndTime })
                    .ToListAsync();

                // Generate time slots (assuming 30-minute appointments)
                var startTime = TimeSpan.Parse(doctor.Clinic.OpeningTime.ToString());
                var endTime = TimeSpan.Parse(doctor.Clinic.ClosingTime.ToString());
                var slots = new List<TimeSpan>();

                for (var time = startTime; time < endTime; time = time.Add(TimeSpan.FromMinutes(30)))
                {
                    if (!existingAppointments.Any(a => 
                        time >= a.StartTime && 
                        time < a.EndTime))
                    {
                        slots.Add(time);
                    }
                }

                return slots;
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error getting available time slots");
                return new List<TimeSpan>();
            }
        }

        public async Task<string> GetFollowUpQuestionsAsync(string specialty)
        {
            if (_followUpQuestions.TryGetValue(specialty, out var questions))
            {
                var response = new StringBuilder();
                response.AppendLine("๐ ุฃุณุฆูุฉ ูุชุงุจุนุฉ ูููุฉ:");
                response.AppendLine("โโโโโโโโโโโโโโ");
                foreach (var question in questions)
                {
                    response.AppendLine($"โข {question}");
                }
                return response.ToString();
            }
            return string.Empty;
        }

        public string GetMedicalInformation(string condition)
        {
            if (_medicalInformation.TryGetValue(condition.ToLower(), out var info))
                return info;

            return $"ูู ุฃุฌุฏ ูุนูููุงุช ูุญุฏุฏุฉ ุนู \"{condition}\". ูุฑุฌู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ููุญุตูู ุนูู ูุนูููุงุช ุฏูููุฉ.";
        }

        public async Task<(bool matched, string response, List<string> suggestedFollowUp)> GetEnhancedMedicalAdviceAsync(string symptoms, string userId)
        {
            try
            {
                // First get the basic medical advice
                var (matched, basicResponse) = await GetMedicalAdviceAsync(symptoms);
                
                if (!matched)
                {
                    return (false, basicResponse, new List<string>());
                }

                // Add personalization if user is known
                string personalizedGreeting = string.Empty;
                if (!string.IsNullOrEmpty(userId))
                {
                    var patient = await _context.Patients.FirstOrDefaultAsync(p => p.ApplicationUserId == userId);
                    if (patient != null)
                    {
                        personalizedGreeting = $"ูุฑุญุจุงู {patient.FirstName}ุ ุฃูุง ุขุณู ูุณูุงุน ุฐูู. ";
                    }
                    else
                    {
                        personalizedGreeting = "ุฃูุง ุขุณู ูุณูุงุน ุฐูู. ";
                    }
                }
                else
                {
                    personalizedGreeting = "ุฃูุง ุขุณู ูุณูุงุน ุฐูู. ";
                }

                // Generate follow-up questions based on symptoms
                var followUpQuestions = await GetDetailedSymptomQuestionsAsync(symptoms);
                
                // Assess urgency level
                var urgencyLevel = AssessUrgencyLevel(symptoms);
                var urgencyAdvice = GetUrgencyLevelText(urgencyLevel);
                
                // Build enhanced response
                var enhancedResponse = new StringBuilder();
                enhancedResponse.AppendLine(personalizedGreeting);
                enhancedResponse.AppendLine(basicResponse);
                enhancedResponse.AppendLine();
                enhancedResponse.AppendLine(urgencyAdvice);
                
                // Detect specialty based on symptoms
                var (specialty, confidence) = await DetectSpecialtyAsync(symptoms);
                if (confidence > 0.6f)
                {
                    enhancedResponse.AppendLine();
                    enhancedResponse.AppendLine($"ุจูุงุกู ุนูู ุงูุฃุนุฑุงุถ ุงูุชู ูุตูุชูุงุ ูุฏ ุชุญุชุงุฌ ุฅูู ุงุณุชุดุงุฑุฉ ุทุจูุจ {specialty}.");
                    
                    // Get recommended doctors for this specialty
                    var recommendedDoctors = await GetRecommendedDoctorsAsync(specialty, userId);
                    if (recommendedDoctors.Any())
                    {
                        enhancedResponse.AppendLine();
                        enhancedResponse.AppendLine("ุงูุฃุทุจุงุก ุงููุชุงุญูู ูุฑูุจุงู:");
                        foreach (var doctor in recommendedDoctors.Take(2))
                        {
                            enhancedResponse.AppendLine($"- ุฏ. {doctor.doctorName} - ูุชุงุญ {doctor.nextAvailable.ToString("yyyy-MM-dd")}");
                        }
                        enhancedResponse.AppendLine("ูู ุชุฑุบุจ ูู ุญุฌุฒ ููุนุฏ ูุน ุฃุญุฏููุ");
                    }
                }

                return (true, enhancedResponse.ToString(), followUpQuestions);
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetEnhancedMedicalAdviceAsync");
                return (false, "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุทูุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.", new List<string>());
            }
        }

        public async Task<(string preliminaryDiagnosis, List<string> possibleConditions, string urgencyLevel)> GeneratePreliminaryDiagnosisAsync(string symptoms, string medicalHistory)
        {
            try
            {
                var preliminaryDiagnosis = string.Empty;
                var possibleConditions = new List<string>();
                
                // Check symptoms against medical conditions patterns
                foreach (var condition in _medicalConditionsPatterns)
                {
                    foreach (var pattern in condition.Value)
                    {
                        if (Regex.IsMatch(symptoms.ToLower(), pattern.ToLower()))
                        {
                            possibleConditions.Add(condition.Key);
                            break;
                        }
                    }
                }

                // Generate preliminary diagnosis text
                if (possibleConditions.Any())
                {
                    preliminaryDiagnosis = "ุจูุงุกู ุนูู ุงูุฃุนุฑุงุถ ุงูุชู ูุตูุชูุงุ ูุฏ ุชููู ูุฐู ุจุนุถ ุงูุญุงูุงุช ุงููุญุชููุฉ:\n\n";
                    foreach (var condition in possibleConditions)
                    {
                        preliminaryDiagnosis += $"โข {condition}: {GetMedicalInformation(condition)}\n\n";
                    }
                    
                    preliminaryDiagnosis += "**ุชูุจูู ูุงู**: ูุฐุง ุชูููู ุฃููู ููุท ูููุณ ุชุดุฎูุตุงู ุทุจูุงู. ูุฑุฌู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ููุญุตูู ุนูู ุชุดุฎูุต ุฏููู ูุฎุทุฉ ุนูุงุฌูุฉ ููุงุณุจุฉ.";
                }
                else
                {
                    preliminaryDiagnosis = "ูู ุฃุชููู ูู ุชุญุฏูุฏ ุญุงูุฉ ูุญุชููุฉ ุจูุงุกู ุนูู ุงูุฃุนุฑุงุถ ุงููุฐููุฑุฉ. ููุฑุฌู ุชูุฏูู ูุฒูุฏ ูู ุงูุชูุงุตูู ุฃู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ูุจุงุดุฑุฉ ููุญุตูู ุนูู ุชูููู ุฏููู.";
                }
                
                // Assess urgency
                var urgencyLevel = AssessUrgencyLevel(symptoms);
                var urgencyText = GetUrgencyLevelText(urgencyLevel);
                
                return (preliminaryDiagnosis, possibleConditions, urgencyText);
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GeneratePreliminaryDiagnosisAsync");
                return ("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุงูุชุดุฎูุต. ูุฑุฌู ุงูุชุญุฏุซ ูุน ุทุจูุจ.", new List<string>(), "ุบูุฑ ูุนุฑูู");
            }
        }

        public async Task<string> GetEmpatheticGreetingAsync(string userId, TimeSpan? timeOfDay = null)
        {
            try
            {
                // Default greetings based on time of day
                timeOfDay ??= DateTime.Now.TimeOfDay;
                string timeGreeting;
                
                if (timeOfDay.Value.Hours >= 5 && timeOfDay.Value.Hours < 12)
                {
                    timeGreeting = "ุตุจุงุญ ุงูุฎูุฑ";
                }
                else if (timeOfDay.Value.Hours >= 12 && timeOfDay.Value.Hours < 17)
                {
                    timeGreeting = "ูุณุงุก ุงูุฎูุฑ";
                }
                else
                {
                    timeGreeting = "ูุณุงุก ุงูุฎูุฑ";
                }
                
                // If user ID is provided, personalize the greeting
                if (!string.IsNullOrEmpty(userId))
                {
                    var patient = await _context.Patients.FirstOrDefaultAsync(p => p.ApplicationUserId == userId);
                    if (patient != null)
                    {
                        // Check if the patient has upcoming appointments
                        var upcomingAppointment = await _context.Appointments
                            .Where(a => a.PatientID == patient.Id && a.AppointmentDate > DateTime.Now)
                            .OrderBy(a => a.AppointmentDate)
                            .FirstOrDefaultAsync();
                            
                        if (upcomingAppointment != null)
                        {
                            var doctor = await _context.Doctors.FindAsync(upcomingAppointment.DoctorID);
                            var daysUntilAppointment = (upcomingAppointment.AppointmentDate - DateTime.Now).Days;
                            
                            if (daysUntilAppointment <= 1)
                            {
                                return $"{timeGreeting} {patient.FirstName}! ุฃุชููู ุฃู ุชููู ุจุฎูุฑ. ุฃูุฏ ุชุฐููุฑู ุจููุนุฏู ุบุฏุงู ูุน ุฏ. {doctor?.FirstName} {doctor?.LastName}. ูู ููุงู ุฃู ุดูุก ุขุฎุฑ ูููููู ูุณุงุนุฏุชู ุจู ุงููููุ";
                            }
                            else if (daysUntilAppointment <= 3)
                            {
                                return $"{timeGreeting} {patient.FirstName}! ููู ุญุงูู ุงููููุ ูุฏูู ููุนุฏ ูุงุฏู ูุน ุฏ. {doctor?.FirstName} {doctor?.LastName} ุจุนุฏ {daysUntilAppointment} ุฃูุงู. ูู ูููููู ูุณุงุนุฏุชู ุจุฃู ุดูุก ุขุฎุฑุ";
                            }
                            else
                            {
                                return $"{timeGreeting} {patient.FirstName}! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ";
                            }
                        }
                        
                        // Check if patient has had a recent appointment
                        var recentAppointment = await _context.Appointments
                            .Where(a => a.PatientID == patient.Id && a.AppointmentDate < DateTime.Now)
                            .OrderByDescending(a => a.AppointmentDate)
                            .FirstOrDefaultAsync();
                            
                        if (recentAppointment != null && (DateTime.Now - recentAppointment.AppointmentDate).TotalDays <= 7)
                        {
                            var doctor = await _context.Doctors.FindAsync(recentAppointment.DoctorID);
                            return $"{timeGreeting} {patient.FirstName}! ููู ุญุงูู ุจุนุฏ ุฒูุงุฑุชู ุงูุฃุฎูุฑุฉ ููุฏูุชูุฑ {doctor?.FirstName} {doctor?.LastName}ุ ูู ููุงู ุฃู ุชุญุณู ูู ุญุงูุชูุ";
                        }
                        
                        return $"{timeGreeting} {patient.FirstName}! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ";
                    }
                }
                
                // Default greeting if no personalization is possible
                return $"{timeGreeting}! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ";
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetEmpatheticGreetingAsync");
                return "ูุฑุญุจุงู! ููู ูููููู ูุณุงุนุฏุชู ุงููููุ";
            }
        }

        public async Task<List<string>> GetDetailedSymptomQuestionsAsync(string initialSymptom)
        {
            var followUpQuestions = new List<string>();
            
            // Common questions for all symptoms
            followUpQuestions.Add("ููุฐ ูุชู ุจุฏุฃุช ุชุดุนุฑ ุจูุฐู ุงูุฃุนุฑุงุถุ");
            followUpQuestions.Add("ูู ุฌุฑุจุช ุฃู ุฃุฏููุฉ ุฃู ุนูุงุฌุงุช ููุฒููุฉุ");
            followUpQuestions.Add("ูู ูุฏูู ุฃู ุญุงูุงุช ุทุจูุฉ ูุฒููุฉ ุฃู ุญุณุงุณูุฉุ");
            
            // Specific questions based on symptom categories
            if (Regex.IsMatch(initialSymptom, @"ุตุฏุงุน|ุงูู.*ุฑุงุณ|ูุฌุน.*ุฑุงุณ", RegexOptions.IgnoreCase))
            {
                followUpQuestions.Add("ูู ุงูุตุฏุงุน ูู ุฌุงูุจ ูุงุญุฏ ูู ุงูุฑุฃุณ ุฃู ูู ูู ุงูุฑุฃุณุ");
                followUpQuestions.Add("ูู ุชุนุงูู ูู ุญุณุงุณูุฉ ููุถูุก ุฃู ุงูุตูุช ูุน ุงูุตุฏุงุนุ");
                followUpQuestions.Add("ูู ุณุจู ุฃู ุฃุตุจุช ุจุตุฏุงุน ููุงุซู ูู ูุจูุ");
                followUpQuestions.Add("ูู ูุตุงุญุจ ุงูุตุฏุงุน ุบุซูุงู ุฃู ููุกุ");
            }
            else if (Regex.IsMatch(initialSymptom, @"ูุนุฏุฉ|ุจุทู|ุงุณูุงู|ุงูุณุงู|ููุก|ุบุซูุงู", RegexOptions.IgnoreCase))
            {
                followUpQuestions.Add("ูู ุชูุงููุช ุทุนุงูุงู ูุฏ ูููู ุณุจุจ ุงููุดููุฉุ");
                followUpQuestions.Add("ูู ูุงุญุธุช ุฃู ุชุบููุฑ ูู ููู ุงูุจุฑุงุฒุ");
                followUpQuestions.Add("ูู ูุตุงุญุจ ุฃูู ุงูุจุทู ุญููุ");
                followUpQuestions.Add("ูู ุชุดุนุฑ ุจุงูุฌูุงูุ");
            }
            else if (Regex.IsMatch(initialSymptom, @"ุณุนุงู|ุตุฏุฑ|ุชููุณ|ุญุณุงุณูุฉ|ุฑุจู", RegexOptions.IgnoreCase))
            {
                followUpQuestions.Add("ูู ุงูุณุนุงู ุฌุงู ุฃู ูุตุญูุจ ุจุงูุจูุบูุ");
                followUpQuestions.Add("ูู ุชุนุงูู ูู ุถูู ูู ุงูุชููุณุ");
                followUpQuestions.Add("ูู ุณุจู ุชุดุฎูุตู ุจุงูุฑุจู ุฃู ุญุณุงุณูุฉ ุงูุตุฏุฑุ");
                followUpQuestions.Add("ูู ุชุดุนุฑ ุจุฃูู ูู ุงูุตุฏุฑ ุนูุฏ ุงูุณุนุงู ุฃู ุงูุชููุณ ุงูุนูููุ");
            }
            else if (Regex.IsMatch(initialSymptom, @"ุญูู|ุงุฑุชูุงุน.*ุญุฑุงุฑุฉ|ุจุฑุฏ|ุงูููููุฒุง", RegexOptions.IgnoreCase))
            {
                followUpQuestions.Add("ูู ุฏุฑุฌุฉ ุญุฑุงุฑุชูุ");
                followUpQuestions.Add("ูู ุชุนุงูู ูู ูุดุนุฑูุฑุฉ ุฃู ุชุนุฑูุ");
                followUpQuestions.Add("ูู ุชุนุงูู ูู ุขูุงู ูู ุงูุนุถูุงุช ุฃู ุงูููุงุตูุ");
                followUpQuestions.Add("ูู ููุช ุนูู ุงุชุตุงู ูุน ุดุฎุต ูุฑูุถ ูุคุฎุฑุงูุ");
            }
            else if (Regex.IsMatch(initialSymptom, @"ุฌูุฏ|ุทูุญ|ุญูุฉ|ุญุจูุจ|ุงูุฒููุง", RegexOptions.IgnoreCase))
            {
                followUpQuestions.Add("ูู ุงูุทูุญ ุงูุฌูุฏู ูุตุญูุจ ุจุญูุฉุ");
                followUpQuestions.Add("ูู ูุธูุฑ ุงูุทูุญ ูู ููุทูุฉ ูุญุฏุฏุฉ ุฃู ูู ูู ุงูุฌุณูุ");
                followUpQuestions.Add("ูู ุงุณุชุฎุฏูุช ููุชุฌุงุช ุฌุฏูุฏุฉ ููุนูุงูุฉ ุจุงูุจุดุฑุฉ ุฃู ุชูุงููุช ุทุนุงูุงู ุฌุฏูุฏุงูุ");
                followUpQuestions.Add("ูู ูุฏูู ุชุงุฑูุฎ ูุน ุงูุฃูุฑุงุถ ุงูุฌูุฏูุฉ ุฃู ุงูุญุณุงุณูุฉุ");
            }
            
            return followUpQuestions;
        }

        public async Task<(bool success, string appointmentDetails)> SendAppointmentReminderAsync(string userId, int appointmentId)
        {
            try
            {
                var appointment = await _context.Appointments.FindAsync(appointmentId);
                if (appointment == null)
                {
                    return (false, "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุนุฏ ุงููุญุฏุฏ.");
                }
                
                var patient = await _context.Patients.FirstOrDefaultAsync(p => p.ApplicationUserId == userId);
                if (patient == null || appointment.PatientID != patient.Id)
                {
                    return (false, "ููุณ ูุฏูู ุตูุงุญูุฉ ุงููุตูู ููุฐุง ุงูููุนุฏ.");
                }
                
                var doctor = await _context.Doctors.FindAsync(appointment.DoctorID);
                if (doctor == null)
                {
                    return (false, "ูู ูุชู ุงูุนุซูุฑ ุนูู ุจูุงูุงุช ุงูุทุจูุจ.");
                }
                
                var clinicInfo = await _context.Clinics.FindAsync(doctor.ClinicID);
                
                // Create reminder message
                var reminderMessage = new StringBuilder();
                reminderMessage.AppendLine($"ุชุฐููุฑ ุจููุนุฏู ุงููุงุฏู:");
                reminderMessage.AppendLine($"ุงูุชุงุฑูุฎ: {appointment.AppointmentDate.ToString("yyyy-MM-dd")}");
                reminderMessage.AppendLine($"ุงูููุช: {appointment.AppointmentDate.ToString("HH:mm")}");
                reminderMessage.AppendLine($"ุงูุทุจูุจ: ุฏ. {doctor.FirstName} {doctor.LastName}");
                
                if (clinicInfo != null)
                {
                    reminderMessage.AppendLine($"ุงูุนููุงู: {clinicInfo.Address}");
                    reminderMessage.AppendLine($"ุฑูู ุงููุงุชู: {clinicInfo.PhoneNumber}");
                }
                
                reminderMessage.AppendLine();
                reminderMessage.AppendLine("ุชุนูููุงุช ูููุฉ:");
                reminderMessage.AppendLine("- ูุฑุฌู ุงูุญุถูุฑ ูุจู ุงูููุนุฏ ุจู 15 ุฏูููุฉ");
                reminderMessage.AppendLine("- ุฅุญุถุงุฑ ุงูุชูุงุฑูุฑ ุงูุทุจูุฉ ุงูุณุงุจูุฉ ุฅู ูุฌุฏุช");
                reminderMessage.AppendLine("- ุฅุญุถุงุฑ ูุงุฆูุฉ ุจุงูุฃุฏููุฉ ุงูุชู ุชุชูุงูููุง ุญุงููุงู");
                
                // Create notification in the system
                var notification = new Notification
                {
                    UserAccountId = int.Parse(userId),
                    Message = reminderMessage.ToString(),
                    CreatedAt = DateTime.Now,
                    IsRead = false
                };
                
                _context.Notifications.Add(notification);
                await _context.SaveChangesAsync();
                
                return (true, reminderMessage.ToString());
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in SendAppointmentReminderAsync");
                return (false, "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุฑุณุงู ุงูุชุฐููุฑ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
        }

        public async Task<string> GetPatientMedicalHistoryAsync(string userId)
        {
            try
            {
                var patient = await _context.Patients.FirstOrDefaultAsync(p => p.ApplicationUserId == userId);
                if (patient == null)
                {
                    return "ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุณุฌู ุงูุทุจู ูููุฑูุถ.";
                }
                
                var medicalHistory = new StringBuilder();
                medicalHistory.AppendLine("ุงูุณุฌู ุงูุทุจู:");
                
                // Get past appointments
                var pastAppointments = await _context.Appointments
                    .Where(a => a.PatientID == patient.Id && a.AppointmentDate < DateTime.Now)
                    .OrderByDescending(a => a.AppointmentDate)
                    .Take(5)
                    .ToListAsync();
                
                if (pastAppointments.Any())
                {
                    medicalHistory.AppendLine("\nุงูุฒูุงุฑุงุช ุงูุณุงุจูุฉ:");
                    foreach (var appointment in pastAppointments)
                    {
                        var doctor = await _context.Doctors.FindAsync(appointment.DoctorID);
                        medicalHistory.AppendLine($"- {appointment.AppointmentDate.ToString("yyyy-MM-dd")}: ุฏ. {doctor?.FirstName} {doctor?.LastName} ({doctor?.Specialization}) - {appointment.Notes ?? "ูุง ุชูุฌุฏ ููุงุญุธุงุช"}");
                    }
                }
                else
                {
                    medicalHistory.AppendLine("\nูุง ุชูุฌุฏ ุฒูุงุฑุงุช ุณุงุจูุฉ ูุณุฌูุฉ.");
                }
                
                // Add chronic conditions if available
                if (!string.IsNullOrEmpty(patient.MedicalHistory))
                {
                    medicalHistory.AppendLine("\nุงูุณุฌู ุงูุทุจู:");
                    medicalHistory.AppendLine(patient.MedicalHistory);
                }
                
                return medicalHistory.ToString();
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetPatientMedicalHistoryAsync");
                return "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฑุฌุงุน ุงูุณุฌู ุงูุทุจู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.";
            }
        }

        public async Task<(bool success, string message)> RecordSymptomHistoryAsync(string userId, string symptoms, string severity)
        {
            try
            {
                var patient = await _context.Patients.FirstOrDefaultAsync(p => p.ApplicationUserId == userId);
                if (patient == null)
                {
                    return (false, "ูู ูุชู ุงูุนุซูุฑ ุนูู ุณุฌู ุงููุฑูุถ.");
                }
                
                // Create a new chat message to record the symptoms
                var chatBotMessage = new ChatBotMessage
                {
                    UserId = userId,
                    Content = $"Symptoms: {symptoms}, Severity: {severity}",
                    Timestamp = DateTime.Now,
                    Role = "system"
                };
                
                _context.chatBotMessages.Add(chatBotMessage);
                await _context.SaveChangesAsync();
                
                return (true, "ุชู ุชุณุฌูู ุงูุฃุนุฑุงุถ ุจูุฌุงุญ ูู ุณุฌูู ุงูุทุจู.");
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in RecordSymptomHistoryAsync");
                return (false, "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฃุนุฑุงุถ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            }
        }

        public async Task<List<(string doctorName, int doctorId, DateTime nextAvailable)>> GetRecommendedDoctorsAsync(string specialty, string userId)
        {
            try
            {
                var result = new List<(string doctorName, int doctorId, DateTime nextAvailable)>();
                
                // Get doctors with the specified specialty
                var doctors = await _context.Doctors
                    .Include(d => d.Specialization)
                    .Where(d => d.Specialization.Name == specialty)
                    .ToListAsync();
                    
                if (!doctors.Any())
                {
                    return result;
                }
                
                foreach (var doctor in doctors)
                {
                    // Find next available slot for this doctor
                    var nextAvailableDate = DateTime.Now.Date;
                    var found = false;
                    
                    // Look for the next 14 days
                    for (int i = 0; i < 14 && !found; i++)
                    {
                        var date = nextAvailableDate.AddDays(i);
                        var availableSlots = await GetAvailableTimeSlots(doctor.Id, date);
                        
                        if (availableSlots.Any())
                        {
                            nextAvailableDate = date;
                            found = true;
                            break;
                        }
                    }
                    
                    if (found)
                    {
                        result.Add((
                            doctorName: $"{doctor.FirstName} {doctor.LastName}",
                            doctorId: doctor.Id,
                            nextAvailable: nextAvailableDate
                        ));
                    }
                }
                
                // Sort by earliest available date
                return result.OrderBy(d => d.nextAvailable).ToList();
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "Error in GetRecommendedDoctorsAsync");
                return new List<(string, int, DateTime)>();
            }
        }

        public async Task<string> GenerateSafetyInstructionsAsync(string symptoms, string urgencyLevel)
        {
            var safetyInstructions = new StringBuilder();
            
            // Check for emergency conditions
            if (Regex.IsMatch(symptoms, @"ุตุฏุฑ|ููุจ|ุชููุณ|ุฃูู.*ุญุงุฏ|ุณูุชุฉ|ููุจุฉ|ุบูุจูุจุฉ|ููุฏุงู.*ูุนู", RegexOptions.IgnoreCase) ||
                urgencyLevel.Contains("ุทูุงุฑุฆ"))
            {
                safetyInstructions.AppendLine("๐จ ุชุนูููุงุช ุงูุณูุงูุฉ ุงูููุฑูุฉ:");
                safetyInstructions.AppendLine("โข ุงุชุตู ุจุงูุฅุณุนุงู ุนูู ุงูููุฑ ุนูู ุงูุฑูู 123");
                safetyInstructions.AppendLine("โข ูุง ุชูู ุจุงูููุงุฏุฉ ุจููุณู ุฅูู ุงููุณุชุดูู");
                safetyInstructions.AppendLine("โข ุงุจู ูุงุฏุฆุงู ูุญุงูุธ ุนูู ุงูุชููุณ ุจุงูุชุธุงู");
                safetyInstructions.AppendLine("โข ูุง ุชุฃูู ุฃู ุชุดุฑุจ ุญุชู ูุตูู ุงููุณุงุนุฏุฉ ุงูุทุจูุฉ");
            }
            else if (Regex.IsMatch(symptoms, @"ุญูู|ุงุฑุชูุงุน.*ุญุฑุงุฑุฉ|ุตุฏุงุน.*ุดุฏูุฏ|ููุก.*ูุณุชูุฑ", RegexOptions.IgnoreCase) ||
                    urgencyLevel.Contains("ุนุงุฌู"))
            {
                safetyInstructions.AppendLine("โ๏ธ ุชุนูููุงุช ูููุฉ:");
                safetyInstructions.AppendLine("โข ุฑุงุฌุน ุฃูุฑุจ ูุฑูุฒ ุทุจู ูู ุฃูุฑุจ ููุช ูููู");
                safetyInstructions.AppendLine("โข ุฎุฐ ูุณุทุงู ูู ุงูุฑุงุญุฉ ูุชุฌูุจ ุงููุฌููุฏ ุงูุจุฏูู");
                safetyInstructions.AppendLine("โข ุญุงูุธ ุนูู ุชุฑุทูุจ ุฌุณูู ุจุดุฑุจ ุงูุณูุงุฆู ุจูุซุฑุฉ");
                
                if (Regex.IsMatch(symptoms, @"ุญูู|ุงุฑุชูุงุน.*ุญุฑุงุฑุฉ", RegexOptions.IgnoreCase))
                {
                    safetyInstructions.AppendLine("โข ูููู ุงุณุชุฎุฏุงู ุฎุงูุถ ููุญุฑุงุฑุฉ ูุซู ุงูุจุงุฑุงุณูุชุงููู ูููุงู ููุฌุฑุนุฉ ุงูููุตู ุจูุง");
                    safetyInstructions.AppendLine("โข ุถุน ููุงุฏุงุช ุจุงุฑุฏุฉ ุนูู ุงูุฌุจูุฉ ูุงูุฑูุจุฉ ูููุณุงุนุฏุฉ ูู ุฎูุถ ุงูุญุฑุงุฑุฉ");
                }
            }
            else
            {
                safetyInstructions.AppendLine("๐ ูุตุงุฆุญ ุนุงูุฉ:");
                safetyInstructions.AppendLine("โข ุงุญุฑุต ุนูู ุงูุฑุงุญุฉ ุงููุงููุฉ");
                safetyInstructions.AppendLine("โข ุงุดุฑุจ ูููุงุช ูุงููุฉ ูู ุงููุงุก");
                safetyInstructions.AppendLine("โข ุชูุงูู ุบุฐุงุกู ุตุญูุงู ููุชูุงุฒูุงู");
                safetyInstructions.AppendLine("โข ุฑุงูุจ ุงูุฃุนุฑุงุถ ูุณุฌููุง ููุดุงุฑูุชูุง ูุน ุงูุทุจูุจ");
                safetyInstructions.AppendLine("โข ุฅุฐุง ุงุณุชูุฑุช ุงูุฃุนุฑุงุถ ุฃู ุณุงุกุชุ ุฑุงุฌุน ุงูุทุจูุจ");
            }
            
            return safetyInstructions.ToString();
        }
    }

    public class AppointmentBookingState
    {
        public int DoctorId { get; set; }
        public int PatientId { get; set; }
        public BookingStep CurrentStep { get; set; }
        public DateTime AppointmentDate { get; set; }
        public TimeSpan AppointmentTime { get; set; }
        public Doctors Doctor { get; set; }
    }

    public enum BookingStep
    {
        SelectDate,
        SelectTime,
        Confirm
    }
} 