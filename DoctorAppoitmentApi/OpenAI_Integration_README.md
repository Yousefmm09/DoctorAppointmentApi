# تكامل OpenAI المتقدم في نظام مواعيد الأطباء

## نظرة عامة
تم تحديث تكامل OpenAI API في التطبيق لتوفير تجربة أكثر قوة وشمولًا. يتضمن التكامل الجديد دعمًا للنماذج المتقدمة، والتخزين المؤقت للاستجابات، ودعمًا أفضل للغة العربية، وقدرات التضمين الدلالي.

## الميزات الرئيسية

### 1. دعم متعدد النماذج
- **النموذج الأساسي**: `gpt-3.5-turbo-0125` (أقل تكلفة، مناسب للاستخدام العام)
- **النموذج المتقدم**: `gpt-4` (أكثر قوة، للاستفسارات الطبية المعقدة)
- **نموذج التضمين**: `text-embedding-3-small` (للبحث الدلالي)

### 2. الاستجابات المحلية الذكية
- تجنب استدعاءات API غير الضرورية عن طريق معالجة الأنماط الشائعة محليًا
- دعم متطور للغة العربية مع استجابات محلية للاستفسارات الشائعة

### 3. التخزين المؤقت للاستجابات
- تخزين الاستجابات المتكررة لتحسين الأداء وتقليل تكلفة API
- تكوين مدة التخزين المؤقت في الإعدادات

### 4. قدرات التضمين الدلالي
- إنشاء تضمينات نصية للبحث الدلالي
- مفيد للعثور على المعلومات ذات الصلة في قاعدة البيانات الطبية

### 5. تعزيز دعم اللغة العربية
- قالب نظام مخصص للاستجابات باللغة العربية
- اكتشاف تلقائي للاستفسارات العربية والرد بشكل طبيعي

## الإعداد والتكوين

### 1. الحصول على مفتاح API من OpenAI
1. قم بزيارة [platform.openai.com](https://platform.openai.com/) وسجل الدخول
2. انتقل إلى قسم "API Keys" في لوحة القيادة
3. قم بإنشاء مفتاح API جديد واحتفظ به في مكان آمن

### 2. تكوين مفتاح API

**باستخدام البرامج النصية المتوفرة:**

```powershell
# تعيين مفتاح API كمتغير بيئي
.\setup-api-key.ps1 -ApiKey "مفتاح-API-الخاص-بك"

# اختبار الاتصال مع OpenAI
.\TestOpenAI.ps1
```

**يدويًا:**
1. قم بتعيين متغير بيئي يسمى `OPENAI_API_KEY` بقيمة مفتاح API الخاص بك
2. أو قم بتكوينه في ملف `appsettings.json` في قسم `OpenAI:ApiKey`

### 3. الإعدادات المتقدمة
تم تحديث ملف `appsettings.json` بمجموعة شاملة من خيارات التكوين:

```json
"OpenAI": {
  "ApiKey": "",
  "RateLimitDelayMs": 2000,
  "MaxRetries": 5,
  "TimeoutSeconds": 30,
  "MaxTokens": 150,
  "Temperature": 0.7,
  "Model": "gpt-3.5-turbo-0125",
  "AdvancedModel": "gpt-4",
  "EmbeddingModel": "text-embedding-3-small",
  "EnableAudioTranscription": false,
  "EnableImageGeneration": false,
  "UseSystemPromptTemplate": true,
  "SystemPromptTemplate": "أنت مساعد طبي ذكي لنظام حجز مواعيد الأطباء...",
  "CacheResponsesMinutes": 60,
  "UseAdvancedService": true
}
```

### 4. التحقق من التكامل
لاختبار ما إذا كانت API تعمل بشكل صحيح:

1. قم بتشغيل واجهة API بواسطة `dotnet run`
2. أرسل استعلامًا إلى النقطة النهائية للدردشة: `/api/ChatBot/chat`
3. تحقق من السجلات للتأكد من أن طلب OpenAI يعمل بشكل صحيح

## ميزات التكامل المتقدمة

### الاختيار التلقائي للنموذج
يقوم النظام تلقائيًا باختيار النموذج المناسب بناءً على تعقيد الاستعلام:
- الاستفسارات البسيطة: تستخدم النموذج الأساسي (gpt-3.5-turbo)
- الاستفسارات المعقدة (الطبية، المحادثات الطويلة): تستخدم النموذج المتقدم (gpt-4)

### التخزين المؤقت الذكي
- يتم تخزين الاستجابات المتكررة مؤقتًا للأداء المحسن
- يمكن تكوين مدة التخزين المؤقت في الإعدادات

### قدرات التضمين
يمكنك استخدام وظيفة `GenerateEmbeddingAsync` لإنشاء تضمينات متجهة للنص:

```csharp
IOpenAIService openAIService = // احصل عليها من حقن التبعية
float[] embeddings = await openAIService.GenerateEmbeddingAsync("نص طبي للتضمين");
// استخدم هذه التضمينات للبحث الدلالي
```

## استكشاف الأخطاء وإصلاحها

### خطأ 429 (طلبات كثيرة جدًا)
- تم تحسين آلية التراجع الأسي للتعامل مع حدود الطلبات
- قم بزيادة `RateLimitDelayMs` إذا استمرت المشكلة

### خطأ 401 (غير مصرح به)
- تأكد من تكوين مفتاح API بشكل صحيح
- تأكد من أن مفتاح API صالح ولم تنته صلاحيته

### صفر رموز / صفر استخدام
إذا استمر ظهور 0.00$ في لوحة التحكم الخاصة بك، قد يكون ذلك بسبب:
- معالجة الاستعلامات محليًا (تجنب استدعاءات API)
- فشل الطلبات بسبب أخطاء (تحقق من السجلات)

## تتبع النظام
- راجع سجلات التطبيق لمراقبة استخدام API
- تم تحسين التسجيل لتوفير معلومات تفصيلية حول كل طلب واستجابة 